<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Basic Secure Chat</title>

<style>
body{margin:0;font-family:sans-serif;background:#f2f2f2;display:flex;align-items:center;justify-content:center;height:100vh}
#pinBox,#chatBox{
  width:90%;max-width:400px;background:#fff;padding:20px;
  border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)
}
#chatBox{display:none}
input,button{
  width:100%;padding:12px;font-size:16px;margin-top:10px;border-radius:6px;
}
button{border:none;background:#008069;color:#fff;font-weight:600}
#messages{
  height:300px;overflow:auto;border:1px solid #ddd;padding:10px;margin:10px 0;border-radius:6px;
  background:#fafafa
}
.msg-me{text-align:right;margin:4px;color:#008069;font-weight:600}
.msg-peer{text-align:left;margin:4px;color:#444;font-weight:600}
#status{text-align:center;margin-top:8px;font-size:14px;font-weight:600}
</style>

</head>
<body>

<!-- PIN SCREEN -->
<div id="pinBox">
  <h3>Enter PIN</h3>
  <input id="pinInput" placeholder="1234">
  <button onclick="join()">Start Chat</button>
  <div id="status">Waiting…</div>
</div>

<!-- CHAT SCREEN -->
<div id="chatBox">
  <h3>Chat</h3>
  <div id="status"></div>
  <div id="messages"></div>
  <input id="msgInput" placeholder="Type message">
  <button onclick="sendMsg()">Send</button>
</div>

<script>
/* BASIC CONFIG */
const SIGNAL_URL = "wss://free-signalling-chat.vercel.app/basic";
let ws, pc, dc, myPin;

/* Update status text */
function setStatus(t,c="#008069"){
  const s=document.getElementById("status");
  s.textContent=t;
  s.style.color=c;
}

/* Join with PIN */
function join(){
  myPin = document.getElementById("pinInput").value.trim();
  if(!myPin) return alert("Enter PIN!");

  ws = new WebSocket(SIGNAL_URL);

  ws.onopen = ()=>{
    setStatus("Signal Connected ✔","#007b39");
    ws.send(JSON.stringify({type:"join",pin:myPin}));
  };

  ws.onerror = ()=> setStatus("Signal Error ❌","red");
  ws.onclose = ()=> setStatus("Signal Closed ❌","red");

  ws.onmessage = async (ev)=>{
    const data = JSON.parse(ev.data);

    if(data.type==="match"){
      setStatus("Peer Found — Connecting…","#444");
      startRTC(true);
    }

    if(data.type==="offer"){
      await startRTC(false);
      await pc.setRemoteDescription(data.sdp);
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      ws.send(JSON.stringify({type:"answer",pin:myPin,sdp:pc.localDescription}));
    }

    if(data.type==="answer"){
      await pc.setRemoteDescription(data.sdp);
    }

    if(data.type==="ice"){
      try{ await pc.addIceCandidate(data.candidate); }catch{}
    }
  };
}

/* Start WebRTC */
async function startRTC(initiator){
  document.getElementById("pinBox").style.display="none";
  document.getElementById("chatBox").style.display="block";

  setStatus("Connecting Peer-to-Peer…","#444");

  pc = new RTCPeerConnection({
    iceServers:[
      {urls:"stun:stun.l.google.com:19302"},
      {
        urls:"turn:openrelay.metered.ca:80",
        username:"openrelayproject",
        credential:"openrelayproject"
      }
    ]
  });

  pc.onicecandidate = e=>{
    if(e.candidate){
      ws.send(JSON.stringify({type:"ice",pin:myPin,candidate:e.candidate}));
    }
  };

  pc.onconnectionstatechange = ()=>{
    if(pc.connectionState==="connected"){
      setStatus("Connected (P2P) ✔","green");
    }
    if(pc.connectionState==="failed"){
      setStatus("Connection Failed ❌","red");
    }
  };

  if(initiator){
    dc = pc.createDataChannel("chat");
    setupDC();
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({type:"offer",pin:myPin,sdp:offer}));
  }
  else{
    pc.ondatachannel = e=>{
      dc = e.channel;
      setupDC();
    };
  }
}

/* Setup DataChannel */
function setupDC(){
  dc.onopen = ()=>{
    setStatus("Chat Ready ✔","green");
  };
  dc.onclose = ()=>{
    setStatus("Chat Closed ❌","red");
  };

  dc.onmessage = e=>{
    addMsg(e.data,"peer");
  };
}

/* Send message */
function sendMsg(){
  const txt=document.getElementById("msgInput").value.trim();
  if(!txt) return;

  addMsg(txt,"me");
  dc.send(txt);
  document.getElementById("msgInput").value="";
}

/* Add message to UI */
function addMsg(t,who){
  const div=document.createElement("div");
  div.className="msg-"+who;
  div.textContent=t;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
}
</script>

</body>
</html>
